<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="ko" xmlns="http://www.w3.org/1999/xhtml">

<head>
	    <meta charset="utf-8"/>
	    <title>Extending Thymeleaf dialect : processing attribute value</title>
	    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	    <meta name="description" content="DevOps를 위한 정보 제공"/>
	    <meta name="author" content="appaga@appaga.kr"/>
	    <meta name="keywords" content="java, spring boot, android"/>
	    <meta name="generator" content="JBake"/>
		<!-- Custom styles for this template -->
    	<link href="https://fonts.googleapis.com/css?family=Playfair&#43;Display:700,900&amp;display=swap" rel="stylesheet">
	    <!-- Le styles -->
		<link href="../../bootstrap/bootstrap.min.css" rel="stylesheet"/>
		<link href="../../bootstrap/blog.css" rel="stylesheet"/>
	    <link href="../../prettify/prettify.css" rel="stylesheet"/>

	    <!-- Fav and touch icons -->
		<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png"/>
		<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png"/>
		<link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png"/>
		<link rel="manifest" href="../../site.webmanifest"/>
	    <link rel="shortcut icon" href="../../favicon.ico"/>		
	</head>

<body>
	<div id="wrap">
		<div>
		<div class="container">
			<header class="blog-header py-3">
				<div class="row flex-nowrap justify-content-between align-items-center">
					<div class="col-4 pt-1">
						<a class="link-secondary" href="../../feed.xml">Subscribe</a>
					</div>
					<div class="col-4 text-center">
						<a class="blog-header-logo text-dark" href="/">APPAGA</a>
					</div>
					<div class="col-4 d-flex justify-content-end align-items-center">
						<a class="btn btn-sm btn-outline-secondary" href="../../about.html">About</a>
					</div>
				</div>
			</header>

			<ul class="nav justify-content-between">
				<li class="nav-item">
					<a class="nav-link" href='../../archive.html'>Archives</a>
				</li>
				<li class="nav-item dropdown">
					<a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#">Tags</a>
					<ul class="dropdown-menu">
						<li>
							<a class="dropdown-item text-uppercase" href='../../tags/centos.html'>centos</a>
						</li>
						<li>
							<a class="dropdown-item text-uppercase" href='../../tags/mongodb.html'>mongodb</a>
						</li>
						<li>
							<a class="dropdown-item text-uppercase" href='../../tags/linux.html'>linux</a>
						</li>
						<li>
							<a class="dropdown-item text-uppercase" href='../../tags/apache.html'>apache</a>
						</li>
						<li>
							<a class="dropdown-item text-uppercase" href='../../tags/database.html'>database</a>
						</li>
						<li>
							<a class="dropdown-item text-uppercase" href='../../tags/analytics.html'>analytics</a>
						</li>
						<li>
							<a class="dropdown-item text-uppercase" href='../../tags/eclipse.html'>eclipse</a>
						</li>
						<li>
							<a class="dropdown-item text-uppercase" href='../../tags/javascript.html'>javascript</a>
						</li>
						<li>
							<a class="dropdown-item text-uppercase" href='../../tags/springboot.html'>springboot</a>
						</li>
						<li>
							<a class="dropdown-item text-uppercase" href='../../tags/thymeleaf.html'>thymeleaf</a>
						</li>
						<li>
							<a class="dropdown-item text-uppercase" href='../../tags/google.html'>google</a>
						</li>
						<li>
							<a class="dropdown-item text-uppercase" href='../../tags/ubuntu.html'>ubuntu</a>
						</li>
						<li>
							<a class="dropdown-item text-uppercase" href='../../tags/tomcat.html'>tomcat</a>
						</li>
					</ul>
				</li>
			</ul>
		</div>
	</div>
		<main class="container">
			<div class="page-header">
				<h1>Extending Thymeleaf dialect : processing attribute value</h1>
			</div>
			<p><em>17 April 2020</em></p>
			<p><h1>thymeleaf dialect 확장하여 태그 속성값을 변환하여 출력하기</h1>
<p>타임리프 속성의 값으로 입력된 값을 처리하여 원하는 출력으로 변환하고자 한다.</p>
<p><code>tlmd</code> dialect를 만들고 <code>ox</code> 속성을 추가한다.</p>
<p>속성에 입력한 값이 <code>true</code>에 해당하는 값(<code>0</code>이 아닌 숫자, <code>false</code>가 아닌 문자열 등) 이면 <code>●</code>을 출력하고,<br />
<code>false</code>에 해당하는 값(숫자 <code>0</code>, <code>false</code>, <code>null</code> 등) 이면 <code>○</code>을 출력한다.</p>
<pre><code class="language-html">&lt;td tlmd:ox=&quot;${item.user.active_yn}&quot;&gt;active_yn&lt;/td&gt;
</code></pre>
<p>위와 같이 코딩을 하면 <code>${item.user.active_yn}</code>이 <code>1</code> 문자열을 가지고 있기 때문에 아래와 같이 화면에 출력된다.</p>
<pre><code class="language-html">&lt;td&gt;●&lt;/td&gt;
</code></pre>
<p><a href="https://www.thymeleaf.org/doc/articles/sayhelloagainextendingthymeleafevenmore5minutes.html">타임리프 참조사이트</a></p>
<h2>custom dialect 클래스</h2>
<p><code>AbstractProcessorDialect</code>을 확장하여 <code>TlmdDialect</code> 클래스를 생성한다.</p>
<pre><code class="language-java">public class TlmdDialect extends AbstractProcessorDialect {
	private static final String PREFIX = &quot;tlmd&quot;;
	
	public TlmdDialect() {
		super(&quot;Ttallaemideul Dialect&quot; // dialect name
				, PREFIX	// 접두사. 속성 사용방법: tlmd:*
				, 1000 		// dialect 우선순위
				);
	}

	/**
	 * dialect 처리기를 초기화 한다.
	 */
	@Override
	public Set&lt;IProcessor&gt; getProcessors(String dialectPrefix) {
		final Set&lt;IProcessor&gt; processors = new HashSet&lt;&gt;();
		processors.add(new OxAttrTagProcessor(dialectPrefix));
		return processors;
	}

}
</code></pre>
<p><a href="https://github.com/ttallaemideul/springboot/blob/master/tlmd_web/src/main/java/io/github/ttallaemideul/thymeleaf/TlmdDialect.java">TlmdDialect.java</a></p>
<h2>속성태그 처리기 클래스</h2>
<p><code>AbstractAttributeTagProcessor</code>을 확장하여 <code>OxAttrTagProcessor</code> 클래스를 생성한다.</p>
<p>오버라이드한 <code>doProcess</code> 함수에서 속성값(<code>attributeValue</code>)을 파싱 처리하여 값을 <code>attrVal</code> 획득한다.</p>
<p><code>attrVal</code> 값이 <code>true</code>에 해당하면 <code>●</code>을 태그의 바디에 설정하고 아니면 <code>○</code>을 설정한다.</p>
<pre><code class="language-java">@Override
protected void doProcess(ITemplateContext context, IProcessableElementTag tag, AttributeName attributeName,
		String attributeValue, IElementTagStructureHandler structureHandler) {
	// 속성값을 타임리프 표준 표현식으로 파싱한 후 표현식을 처리한다.
	final IEngineConfiguration configuration = context.getConfiguration();
	final IStandardExpressionParser parser = StandardExpressions.getExpressionParser(configuration);
	final IStandardExpression expression = parser.parseExpression(context, attributeValue);
	final Object attrVal = expression.execute(context);
	// 문자열이 true에 해당하는지 판단.
	if (UtilString.isTrue(attrVal)) {
		structureHandler.setBody(YES, false);
	} else {
		structureHandler.setBody(NO, false);
	}
}
</code></pre>
<p><code>isTrue()</code> 함수는 파라미터의 값이 <code>true</code>에 해당하는 경우 <code>true</code>를 리턴한다.<br />
<code>true</code>에 해당하는 문자열은 <code>0</code>이 아닌 숫자, <code>false</code>, <code>null</code>, <code>undefined</code> 문자열이 아닌 경우이다.</p>
<p><a href="https://github.com/ttallaemideul/springboot/blob/master/tlmd_web/src/main/java/io/github/ttallaemideul/thymeleaf/OxAttrTagProcessor.java">OxAttrTagProcessor.java</a></p>
<h2>dialect 등록</h2>
<p>MVC 설정시에 등록한 템플릿 엔진에 생성한 dialect 클래스 <code>TlmdDialect</code>를 등록한다.</p>
<pre><code class="language-java">@Bean
public SpringTemplateEngine templateEngine() {
	SpringTemplateEngine templateEngine = new SpringTemplateEngine();
	templateEngine.setEnableSpringELCompiler(true); // Compiled SpringEL should speed up executions
	templateEngine.setTemplateResolver(templateResolver());
	templateEngine.addDialect(layoutDialect());	// 레이아웃 관리
	templateEngine.addDialect(new HelloDialect()); // 샘플 dialect
	templateEngine.addDialect(new TlmdDialect()); // tlmd dialect
	return templateEngine;
}
</code></pre>
<p><a href="https://github.com/ttallaemideul/springboot/blob/master/tlmd_web/src/main/java/io/github/ttallaemideul/config/WebMvcConfig.java">WebMvcConfig.java</a></p>
<h2>dialect 사용</h2>
<p>웹페이지에 <code>tlmd</code> dialect를 사용함을 명시한다.</p>
<pre><code class="language-xml">&lt;!DOCTYPE html&gt;
&lt;html xmlns:th=&quot;http://www.thymeleaf.org&quot;
      xmlns:layout=&quot;http://www.ultraq.net.nz/thymeleaf/layout&quot;
      xmlns:tlmd=&quot;https://ttallaemideul.github.io&quot;
      layout:decorator=&quot;~{layouts/layout_base}&quot;&gt;
</code></pre>
<p><code>tlmd:ox</code> 태그를 적용한다.</p>
<pre><code class="language-html">&lt;tr th:each=&quot;item : ${userList}&quot;&gt;
  &lt;td th:text=&quot;${item.user.login_id}&quot;&gt;login_id&lt;/td&gt;
  &lt;td th:text=&quot;${item.user.user_name}&quot;&gt;user_name&lt;/td&gt;
  &lt;td tlmd:ox=&quot;${item.user.active_yn}&quot;&gt;active_yn&lt;/td&gt;
  &lt;td tlmd:ox=&quot;${item.user.expired_yn}&quot;&gt;expired_yn&lt;/td&gt;
  &lt;td tlmd:ox=&quot;${item.user.locked_yn}&quot;&gt;locked_yn&lt;/td&gt;
  &lt;td tlmd:ox=&quot;${item.user.pwd_expired_yn}&quot;&gt;pwd_expired_yn&lt;/td&gt;
  &lt;td th:text=&quot;${item.user.reg_dt}&quot;&gt;reg_dt&lt;/td&gt;
  &lt;td th:text=&quot;${item.user.upd_dt}&quot;&gt;upd_dt&lt;/td&gt;
  &lt;td&gt;
  	&lt;span th:each=&quot;role : ${item.roles}&quot;&gt;
  		[[${role.roleNm}]]&lt;small th:text=&quot;|(${role.desc})|&quot;&gt;&lt;/small&gt;&lt;br&gt;
  	&lt;/span&gt;
  &lt;/td&gt;
&lt;/tr&gt;
</code></pre>
<p><a href="https://github.com/ttallaemideul/springboot/blob/master/tlmd_web/src/main/resources/templates/web/admin/admin_main.html">admin_main.html</a></p>
<h2>화면 랜더링 결과</h2>
<p>최종적으로 화면에 나타나는 결과물이다.<br />
<code>정상</code> 컬럼은 데이터베이스에 값이 <code>1</code>이 저장되어 있기 때문에 <code>true</code>에 해당하여 <code>●</code>로 표시된다.</p>
<p><img src="/img/tlmd_web/tlmd_web_002.PNG" alt="tlmd:ox 적용 결과" /></p>
<h2><code>class</code>를 변경하기</h2>
<p>태그 본문의 문자열을 처리하는 것에 추가적으로 태그 속성 중에 <code>class</code>를 변경하도록 하자.</p>
<p><code>w3-css</code>를 사용하고 있기 때문에 <code>w3-color</code> 클래스를 이용할 것 이다.</p>
<p><a href="https://www.w3schools.com/w3css/w3css_colors.asp">W3.CSS Colors</a></p>
<p><code>●</code>를 표시할 때는 <code>w3-text-blue</code> 클래스를 이용하고 <code>○</code>를 표시할 때는 <code>w3-text-gray</code> 클래스를 이용한다.</p>
<p><code>OxAttrTagProcessor</code> 클래스의 <code>doProcess()</code> 함수에서 <code>tag</code> 객체로 부터 <code>class</code> 속성을 얻어 그 값을 가져온다.<br />
이 값에 html 태그의 기존 class 값이 들어있다.</p>
<pre><code class="language-java">final IAttribute cls = tag.getAttribute(CLS);
String oldCls = null;
if (cls != null) {
	oldCls = cls.getValue();
}
</code></pre>
<p>태그의 바디를 설정할 때 <code>structureHandler.setAttribute()</code> 함수로 <code>class</code>를 설정하도록 한다.<br />
이 때, 기존 클래스 <code>oldCls</code>가 존재하면 뒤에 추가하도록 한다.</p>
<p>최종적으로 완료된 <code>OxAttrTagProcessor.doProcess()</code> 함수이다.</p>
<pre><code class="language-java">@Override
protected void doProcess(ITemplateContext context, IProcessableElementTag tag, AttributeName attributeName,
		String attributeValue, IElementTagStructureHandler structureHandler) {
	// 속성값을 타임리프 표준 표현식으로 파싱한 후 표현식을 처리한다.
	final IEngineConfiguration configuration = context.getConfiguration();
	final IStandardExpressionParser parser = StandardExpressions.getExpressionParser(configuration);
	final IStandardExpression expression = parser.parseExpression(context, attributeValue);
	final Object attrVal = expression.execute(context);
	final IAttribute cls = tag.getAttribute(CLS);
	String oldCls = null;
	if (cls != null) {
		oldCls = cls.getValue(); // 기존 class 값.
	}
	// 문자열이 true에 해당하는지 판단.
	if (UtilString.isTrue(attrVal)) {
		if (oldCls != null) {
			// 기존 클래스에 추가
			structureHandler.setAttribute(CLS, oldCls + &quot; &quot; + CLS_YES);
		} else {
			structureHandler.setAttribute(CLS, CLS_YES);
		}
		structureHandler.setBody(YES, false);
	} else {
		if (oldCls != null) {
			structureHandler.setAttribute(CLS, oldCls + &quot; &quot; + CLS_NO);
		} else {
			structureHandler.setAttribute(CLS, CLS_NO);
		}
		structureHandler.setBody(NO, false);
	}
}
</code></pre>
<p>화면은 이제 아래 이미지와 같이 클래스가 적용되어 표시된다.</p>
<p><img src="/img/tlmd_web/tlmd_web_003.PNG" alt="class가 적용된 화면" /></p>
<p>생성된 html 코드를 보면 아래와 같이 경우에 따라 클래스가 추가되었고,<br />
기존 <code>test</code> 클래스가 태그에 있었던 첫 번째 <code>td</code> 태그에는 <code>test</code> 클래스 뒤에 추가되었다.</p>
<pre><code class="language-html"> &lt;td class=&quot;test w3-text-blue&quot;&gt;●&lt;/td&gt;
  &lt;td class=&quot;w3-text-gray&quot;&gt;○&lt;/td&gt;
  &lt;td class=&quot;w3-text-gray&quot;&gt;○&lt;/td&gt;
  &lt;td class=&quot;w3-text-gray&quot;&gt;○&lt;/td&gt;
</code></pre>
<p><a href="https://github.com/thymeleaf/thymeleafexamples-extrathyme">타임리프 참조사이트</a></p>
<h2>샘플 코드</h2>
<p>아래 샘플 프로젝트에서 이 문서에서 설명한 소스를 확인할 수 있다.<br />
프로젝트를 받아서 직접 빌드하여 실행하고 결과를 확인해보면 도움이 될 것이다.</p>
<p><a href="https://github.com/ttallaemideul/springboot/tree/master/tlmd_web">github 샘플 프로젝트</a></p>
</p>
		</main>
	</div>
	<div>
			<footer class="blog-footer">
		    	<p class="muted credit">&copy; 2022 APPAGA.KR</p>
		    	<p>
					<a href="#">Back to top</a>
				</p>
		    </footer>

		    <!-- javascript. Placed at the end of the document so the pages load faster -->
			<script src="../../js/jquery-3.6.0.min.js"></script>
			<script src="../../bootstrap/bootstrap.bundle.min.js"></script>
			<script src="../../prettify/prettify.js"></script>
		    <script src="../../js/appaga.js"></script>
			
			<!-- Global site tag (gtag.js) - Google Analytics -->
			<script async src="https://www.googletagmanager.com/gtag/js?id=G-VB6XQ6972F"></script>
			<script>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());

			gtag('config', 'G-VB6XQ6972F');
			</script>
    	</div>
</body>

</html>