<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="ko" xmlns="http://www.w3.org/1999/xhtml">
	<head>
	    <meta charset="utf-8"/>
	    <title>Springboot with H2 database, multi database</title>
	    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	    <meta name="description" content="DevOps를 위한 정보 제공"/>
	    <meta name="author" content="appaga@appaga.kr"/>
	    <meta name="keywords" content="java, spring framework, spring boot, android, flutter"/>
	    <meta name="generator" content="JBake"/>

	    <!-- Le styles -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
	    <link href="../../css/asciidoctor.css" rel="stylesheet"/>
	    <link href="../../css/base.css" rel="stylesheet"/>
	    <link href="../../css/prettify.css" rel="stylesheet"/>

	    <!-- Fav and touch icons -->
		<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png"/>
		<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png"/>
		<link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png"/>
		<link rel="manifest" href="../../site.webmanifest"/>
	    <link rel="shortcut icon" href="../../favicon.ico"/>

		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-VB6XQ6972F"></script>
		<script>
		  window.dataLayer = window.dataLayer || [];
		  function gtag(){dataLayer.push(arguments);}
		  gtag('js', new Date());

		  gtag('config', 'G-VB6XQ6972F');
		</script>
	</head>
	<body onload="prettyPrint()">
	<div id="wrap">
		<div>
		<div class="container">
		  <header class="blog-header py-3">
		    <div class="row flex-nowrap justify-content-between align-items-center">
		      <div class="col-4 pt-1">
						<a class="link-secondary" href="../../feed.xml">Subscribe</a>
		      </div>
		      <div class="col-4 text-center">
		        <a class="blog-header-logo text-dark" href="/">APPAGA</a>
		      </div>
		      <div class="col-4 d-flex justify-content-end align-items-center">
		        <a href="../../about.html">About</a>
		      </div>
		    </div>
		  </header>

		  <div class="nav-scroller py-1 mb-2">
		    <nav class="nav d-flex justify-content-between">
						<!-- <a class="p-2 link-secondary" th:with="rootpath=(${content.rootpath} ?: '')" th:href="${rootpath}+'tags/mongodb.html'">Mongodb</a> -->
						<a class="p-2 link-secondary" href='../../archive.html'>Archive</a>
		    </nav>
		  </div>
		</div>
	</div>
		<main class="container">

			<div class="page-header">
				<h1>Springboot with H2 database, multi database</h1>
			</div>

			<p><em>11 April 2020</em></p>

			<p><h1>springboot에서 H2 데이터베이스 연동</h1>
<p>스프링부트에 H2 디비를 연동한다.<br />
다중 데이터베이스 연결을 지원하기 위해서 맵퍼 어노테이션을 이용한다.</p>
<h2>의존성 추가 <code>pom.xml</code></h2>
<pre><code class="language-xml">&lt;dependency&gt;
	&lt;groupId&gt;com.h2database&lt;/groupId&gt;
	&lt;artifactId&gt;h2&lt;/artifactId&gt;
	&lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre>
<p><a href="https://github.com/ttallaemideul/springboot/blob/master/tlmd_web/pom.xml">pom.xml</a></p>
<h2>프로퍼티 설정 <code>application.properties</code></h2>
<pre><code>spring.datasource.hikari.jdbc-url=jdbc:h2:mem:test;MODE=PostgreSQL;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
spring.datasource.hikari.username=sa
spring.datasource.hikari.password=
spring.datasource.hikari.driver-class-name=org.h2.Driver
spring.datasource.hikari.maximum-pool-size=100 
spring.datasource.hikari.connection-test-query=SELECT 1
spring.datasource.hikari.minimum-idle=5 
spring.datasource.hikari.connection-timeout=100000
</code></pre>
<p><a href="https://github.com/ttallaemideul/springboot/blob/master/tlmd_web/src/main/resources/config/application-local-db.properties">application-local-db.properties</a></p>
<h2>H2용 맵퍼 어노테이션 생성</h2>
<p>다중 데이터베이스 소스에 연결할 수 있도록 맵퍼 어노테이션을 정의하여 맵퍼에서 이용한다.<br />
나중에 새로운 디비 연결을 추가하기가 용이해진다.</p>
<pre><code class="language-java">@Target({ ElementType.TYPE }) 
@Retention(RetentionPolicy.RUNTIME) 
@Documented 
@Component
public @interface DbH2ConnMapper {
	String value() default &quot;&quot;;
}
</code></pre>
<p><a href="https://github.com/ttallaemideul/springboot/blob/master/tlmd_web/src/main/java/io/github/ttallaemideul/config/database/DbH2ConnMapper.java">DbH2ConnMapper.java</a></p>
<p>H2용 맵퍼 어노테이션과 연동되는 디비 연결을 설정한다.</p>
<pre><code class="language-java">@Configuration
@MapperScan(basePackages =  &quot;io.github.ttallaemideul.**&quot;
	, annotationClass = DbH2ConnMapper.class
	, sqlSessionFactoryRef = &quot;dbH2SessionFactory&quot;)
@EnableTransactionManagement
public class DbH2DatabaseConfig {
...
}
</code></pre>
<p>스프링부트 어플리케이션이 기동될 때 테이블을 생성하고 초기 데이터를 생성하도록 초기화코드를 추가한다.</p>
<pre><code class="language-java">@Bean(name=&quot;dbH2DataSourceInitializer&quot;)
public DataSourceInitializer dataSourceInitializer(@Qualifier(&quot;dbH2DataSource&quot;) DataSource datasource) {
	ResourceDatabasePopulator resourceDatabasePopulator = new ResourceDatabasePopulator();
	resourceDatabasePopulator.addScript(new ClassPathResource(&quot;config/database/h2-schema.sql&quot;));
	resourceDatabasePopulator.addScript(new ClassPathResource(&quot;config/database/h2-data.sql&quot;));

	DataSourceInitializer dataSourceInitializer = new DataSourceInitializer();
	dataSourceInitializer.setDataSource(datasource);
	dataSourceInitializer.setDatabasePopulator(resourceDatabasePopulator);
	return dataSourceInitializer;
}
</code></pre>
<p><a href="https://github.com/ttallaemideul/springboot/blob/master/tlmd_web/src/main/java/io/github/ttallaemideul/config/database/DbH2DatabaseConfig.java">DbH2DatabaseConfig.java</a></p>
<h2>맵퍼 생성</h2>
<p>H2 디비에 쿼리를 실행하는 맵퍼 인터페이스를 생성한다.<br />
앞에서 정의한 <code>@DbH2ConnMapper</code> 어노테이션을 추가했기 때문에 H2 디비에서 쿼리가 실행된다.</p>
<pre><code class="language-java">@DbH2ConnMapper
public interface H2MapperH2 {

	public Date getServerNow();
	public List&lt;Map&lt;String, Object&gt;&gt; getUsers();
}
</code></pre>
<p><a href="https://github.com/ttallaemideul/springboot/blob/master/tlmd_web/src/main/java/io/github/ttallaemideul/sample/h2/H2MapperH2.java">H2MapperH2.java</a></p>
<h2>thymeleaf th:each로 목록 표시</h2>
<p>배열 형태의 객체는 타임리프의 <code>th:each</code>로 표시할 수 있다.</p>
<p>컨트롤러에서 <code>List</code>로 뷰에 <code>users</code> 객체를 전달한다. 이 객체는 사용자 목록을 가지고 있다.</p>
<pre><code class="language-java">@GetMapping
public String main(Model model) {
	List&lt;Map&lt;String, Object&gt;&gt; users = h2Service.getUsers();
	if(log.isDebugEnabled()) {
		log.debug(&quot;users={}&quot;, users);
	}
	model.addAttribute(&quot;serverNow&quot;, h2Service.getServerNow());
	model.addAttribute(&quot;users&quot;, users);
	return &quot;sample/h2/main&quot;;
}
</code></pre>
<p><a href="https://github.com/ttallaemideul/springboot/blob/master/tlmd_web/src/main/java/io/github/ttallaemideul/sample/h2/H2Controller.java">H2Controller.java</a></p>
<p>타임리프 <code>th:each=&quot;user : ${users}&quot;</code> 태그는 <code>${users}</code> 목록의 객체 하나씩을  <code>user</code> 객체로 세팅하여 루프에서 사용하도록 한다.</p>
<pre><code class="language-html">&lt;tr th:each=&quot;user : ${users}&quot;&gt;
  &lt;td th:text=&quot;${user.USERID}&quot;&gt;USERID&lt;/td&gt;
  &lt;td th:text=&quot;${user.FIRST_NAME}&quot;&gt;first_name&lt;/td&gt;
  &lt;td th:text=&quot;${user.LAST_NAME}&quot;&gt;last_name&lt;/td&gt;
  &lt;td th:text=&quot;${user.EMAIL}&quot;&gt;email&lt;/td&gt;
  &lt;td th:text=&quot;${user.REG_DT}&quot;&gt;reg_dt&lt;/td&gt;
&lt;/tr&gt;
</code></pre>
<p><a href="https://github.com/ttallaemideul/springboot/blob/master/tlmd_web/src/main/resources/templates/sample/h2/main.html">main.html</a></p>
<p>최종적으로 아래와 같은 화면이 구현된다.</p>
<p><img src="/img/tlmd_web/tlmd_web_001.png" alt="html결과" /></p>
<h2>샘플 프로젝트</h2>
<p>아래 샘플 소스코드에서 이 문서에서 설명한 소스를 확인할 수 있다.<br />
프로젝트를 받아서 직접 빌드하여 실행하고 결과를 확인해보면 도움이 될 것이다.</p>
<p><a href="https://github.com/ttallaemideul/springboot">github 샘플 프로젝트</a></p>
</p>

			<hr />

		</main>
	</div>
	<div>
			<div id="push"></div>

		    <footer class="blog-footer">
		      <div class="container">
		        <p class="muted credit">&copy; 2022 APPAGA.KR</p>
		      </div>
		    </footer>

		    <!-- javascript. Placed at the end of the document so the pages load faster -->
			<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
			<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
		    <script src="../../js/prettify.js"></script>

    	</div>
  </body>
</html>
